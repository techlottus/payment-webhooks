import { Body, Controller, Post, Res } from '@nestjs/common';
import { UtilsService } from 'src/utils/utils.service';
import { EmailService } from './email.service';
import { catchError, mergeMap, take } from 'rxjs';
import Handlebars from "handlebars";

@Controller('email')
export class EmailController {
  constructor(public utils: UtilsService, public email: EmailService) {}

  @Post('/salesforce/send')
  sendEmail(@Body() body: any, @Res() response: any ) {
    // console.log(body);
    const {
      template, 
      subject, 
      toAddress
    } = body
    let templatein = `<!doctype html>\n<html lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n<head>\n<title>ðŸŽ“ Confirmamos tu inscripci&oacute;n, &iexcl;prep&aacute;rate para comenzar!</title>\n<!--[if !mso]><!-->\n<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n<!--<![endif]-->\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<style type=\"text/css\">\n#outlook a{padding:0;}body{margin:0;padding:0;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;}table,td{border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt;}img{border:0;height:auto;line-height:100%;outline:none;text-decoration:none;-ms-interpolation-mode:bicubic;}p{display:block;margin:0;}\n</style>\n<!--[if mso]> <noscript><xml><o:OfficeDocumentSettings><o:AllowPNG/><o:PixelsPerInch>96</o:PixelsPerInch></o:OfficeDocumentSettings></xml></noscript>\n<![endif]-->\n<!--[if lte mso 11]>\n<style type=\"text/css\">\n.ogf{width:100% !important;}\n</style>\n<![endif]-->\n<!--[if !mso]><!-->\n<link href=\"https://fonts.googleapis.com/css?family=Poppins:600,400,700\" rel=\"stylesheet\" type=\"text/css\">\n<style type=\"text/css\">\n\n</style>\n<!--<![endif]-->\n<style type=\"text/css\">\n@media only screen and (min-width:599px){.xc504{width:504px!important;max-width:504px;}.xc600{width:600px!important;max-width:600px;}.xc568{width:568px!important;max-width:568px;}}\n</style>\n<style media=\"screen and (min-width:599px)\">.moz-text-html .xc504{width:504px!important;max-width:504px;}.moz-text-html .xc600{width:600px!important;max-width:600px;}.moz-text-html .xc568{width:568px!important;max-width:568px;}\n</style>\n<style type=\"text/css\">\n@media only screen and (max-width:598px){table.fwm{width:100%!important;}td.fwm{width:auto!important;}}\n</style>\n<style type=\"text/css\">\nu+.emailify .gs{background:#000;mix-blend-mode:screen;display:inline-block;padding:0;margin:0;}u+.emailify .gd{background:#000;mix-blend-mode:difference;display:inline-block;padding:0;margin:0;}p{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}a[x-apple-data-detectors]{color:inherit!important;text-decoration:none!important;}u+.emailify a{color:inherit!important;text-decoration:none!important;}#MessageViewBody a{color:inherit!important;text-decoration:none!important;}td.b .klaviyo-image-block{display:inline;vertical-align:middle;}\n@media only screen and (max-width:599px){.emailify{height:100%!important;margin:0!important;padding:0!important;width:100%!important;}u+.emailify .glist{margin-left:1em!important;}td.ico.v>div.il>a.l.m,td.ico.v .mn-label{padding-right:0!important;padding-bottom:16px!important;}td.x{padding-left:0!important;padding-right:0!important;}.fwm img{max-width:100%!important;height:auto!important;}.aw img{width:auto!important;margin-left:auto!important;margin-right:auto!important;}.awl img{width:auto!important;margin-right:auto!important;}.awr img{width:auto!important;margin-left:auto!important;}.ah img{height:auto!important;}td.b.nw>table,td.b.nw a{width:auto!important;}td.stk{border:0!important;}td.u{height:auto!important;}br.sb{display:none!important;}.thd-1 .i-thumbnail{display:inline-block!important;height:auto!important;overflow:hidden!important;}.hd-1{display:block!important;height:auto!important;overflow:visible!important;}.hm-1{display:none!important;max-width:0!important;max-height:0!important;overflow:hidden!important;mso-hide:all!important;}.ht-1{display:table!important;height:auto!important;overflow:visible!important;}.hr-1{display:table-row!important;height:auto!important;overflow:visible!important;}.hc-1{display:table-cell!important;height:auto!important;overflow:visible!important;}div.h.h>table>tbody>tr>td{height:NaNpx!important}div.h.pt-32>table>tbody>tr>td{padding-top:32px!important}div.h.pr-16>table>tbody>tr>td{padding-right:16px!important}div.h.pb-32>table>tbody>tr>td{padding-bottom:32px!important}div.h.pl-16>table>tbody>tr>td{padding-left:16px!important}td.i.h img,td.i.h td{height:NaNpx!important}td.x.fs-20 span,td.x.fs-20>div,td.x.fs-20{font-size:20px!important}div.r.pr-16>table>tbody>tr>td,div.r.pr-16>div>table>tbody>tr>td{padding-right:16px!important}div.r.pl-16>table>tbody>tr>td,div.r.pl-16>div>table>tbody>tr>td{padding-left:16px!important}td.x.fs-18 span,td.x.fs-18>div,td.x.fs-18{font-size:18px!important}td.x.fs-14 span,td.x.fs-14>div,td.x.fs-14{font-size:14px!important}td.x.al-l>div,td.x.al-l>div>p,td.x.al-l>p,td.x.al-l>div>h1,td.x.al-l>h1{text-align:left!important}div.r.pt-0>table>tbody>tr>td,div.r.pt-0>div>table>tbody>tr>td{padding-top:0px!important}div.r.pb-16>table>tbody>tr>td,div.r.pb-16>div>table>tbody>tr>td{padding-bottom:16px!important}td.b.fw-1>table{width:100%!important}td.fw-1>table>tbody>tr>td>a{display:block!important;width:100%!important;padding-left:0!important;padding-right:0!important;}td.b.fw-1>table{width:100%!important}td.fw-1>table>tbody>tr>td{width:100%!important;padding-left:0!important;padding-right:0!important;}}\n@media screen yahoo{.hd-1,.ds-1{mso-hide:all!important;display:none!important;height:0!important;overflow:hidden!important;}}\n@media (prefers-color-scheme:light) and (max-width:599px){.ds-1.hd-1{display:none!important;height:0!important;overflow:hidden!important;}}\n@media (prefers-color-scheme:dark) and (max-width:599px){.ds-1.hd-1{display:block!important;height:auto!important;overflow:visible!important;}}\n@media (prefers-color-scheme:dark){td.x.dt-FFFFFE *{color:#FFFFFE!important}div.c.dt-000000 *{color:#000000!important}}\n</style>\n<meta name=\"color-scheme\" content=\"light dark\">\n<meta name=\"supported-color-schemes\" content=\"light dark\">\n<!--[if gte mso 9]>\n<style>a:link,span.MsoHyperlink{mso-style-priority:99;color:inherit;text-decoration:none;}a:visited,span.MsoHyperlinkFollowed{mso-style-priority:99;color:inherit;text-decoration:none;}li{text-indent:-1em;}table,td,p,div,span,ul,ol,li,a{mso-hyphenate:none;}sup,sub{font-size:100% !important;}\n</style>\n<![endif]-->\n</head>\n<body lang=\"en\" link=\"#DD0000\" vlink=\"#DD0000\" class=\"emailify\" style=\"mso-line-height-rule:exactly;mso-hyphenate:none;word-spacing:normal;background-color:#ffffff;\"><div class=\"bg\" style=\"background-color:#ffffff;\" lang=\"en\">\n<!--[if mso | IE]>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\"><v:image style=\"border:0;height:400px;mso-position-horizontal:center;position:absolute;top:0;width:600px;z-index:-3;\" src=\"https://e.hypermatic.com/62ebd1ea24ab4d4e95f6ca415b9f8a78.jpg\" xmlns:v=\"urn:schemas-microsoft-com:vml\"/><v:rect style=\"border:0;height:400px;mso-position-horizontal:center;position:absolute;top:0;width:600px;z-index:-4;\" fillcolor=\"transparent\" stroke=\"false\" strokecolor=\"none\" strokeweight=\"0\" xmlns:v=\"urn:schemas-microsoft-com:vml\"/>\n<![endif]--><div class=\"h  pt-32 pr-16 pb-32 pl-16\" style=\"margin:0 auto;max-width:600px;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"><tbody><tr style=\"vertical-align:top;\"><td background=\"https://e.hypermatic.com/62ebd1ea24ab4d4e95f6ca415b9f8a78.jpg\" style=\"background:transparent url('https://e.hypermatic.com/62ebd1ea24ab4d4e95f6ca415b9f8a78.jpg') no-repeat center center / cover; background-size: cover;background-position:center center;background-repeat:no-repeat;padding:34px 16px 16px 16px;vertical-align:top;height:350px;\" height=\"350\">\n<!--[if mso | IE]>\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"width:600px;\" width=\"600\"><tr><td style=\"padding:34px 16px 16px 16px;\">\n<![endif]--><div class=\"mj-hero-content\" style=\"margin:0px auto;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;margin:0;\"><tbody><tr><td style>\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;margin:0;\"><tbody><tr><td align=\"center\" class=\"h  m\" style=\"font-size:0;padding:0;padding-bottom:24px;word-break:break-word;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0;\"><tbody><tr><td style=\"width:101px;\"> <img alt src=\"https://e.hypermatic.com/551d8b3a5410655112748d6b82dfc8df.png\" style=\"border:0;display:block;outline:none;text-decoration:none;height:auto;width:100%;font-size:13px;\" title width=\"101\" height=\"auto\">\n</td></tr></tbody></table>\n</td></tr><tr><td align=\"center\" class=\"x  fs-20\" style=\"font-size:0;padding-bottom:0;word-break:break-word;\"><div style=\"text-align:center;\"><p style=\"Margin:0;text-align:center;mso-line-height-alt:36px;mso-ansi-font-size:28px;\"><span style=\"font-size:28px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#ffffff;line-height:125%;mso-line-height-alt:36px;mso-ansi-font-size:28px;\">Te damos la bienvenida a la Universidad Latinoamericana</span></p></div>\n</td></tr></tbody></table>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:32px 48px 16px 48px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:top;width:504px;\">\n<![endif]--><div class=\"xc504 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:none;vertical-align:top;\" width=\"100%\"><tbody><tr><td align=\"left\" class=\"x  fs-18\" style=\"font-size:0;word-break:break-word;\"><div style=\"text-align:left;\"><p style=\"Margin:0;text-align:left;mso-line-height-alt:40px;mso-ansi-font-size:32px;\"><span style=\"font-size:32px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#18181b;line-height:125%;mso-line-height-alt:40px;mso-ansi-font-size:32px;\">Hola&nbsp;</span><span style=\"font-size:32px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#2b897e;line-height:125%;mso-line-height-alt:40px;mso-ansi-font-size:32px;\">Claura Figueroa ðŸ‘‹</span></p></div>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 48px 16px 48px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:top;width:504px;\">\n<![endif]--><div class=\"xc504 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:none;vertical-align:top;\" width=\"100%\"><tbody><tr><td align=\"left\" class=\"a\" style=\"background:transparent;font-size:0;padding:0;word-break:break-word;\">\n<table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\" style=\"color:#000000;font-family:Arial,sans-serif;font-size:13px;line-height:22px;table-layout:fixed;width:100%;border:none;\"><tr class=\"q \" ><td align=\"left\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  fs-14 \" align=\"left\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">Plantel:</span></p>\n</td></tr></table>\n</td><td class=\"tgtr\" style=\"vertical-align:middle;color:transparent;font-size:0;\" width=\"1.5873015873015872%\">&#8203;\n</td><td align=\"right\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  fs-14 \" align=\"right\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">online</span></p>\n</td></tr></table>\n</td></tr><tr class><td class=\"s\" style=\"font-size:0;padding:0;padding-bottom:0;word-break:break-word;color:transparent;\" aria-hidden=\"true\"><div style=\"height:8px;line-height:8px;\">&#8203;</div>\n</td></tr><tr class=\"q \" ><td align=\"right\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  \" align=\"right\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">Fecha de inicio:</span></p>\n</td></tr></table>\n</td><td class=\"tgtr\" style=\"vertical-align:middle;color:transparent;font-size:0;\" width=\"1.5873015873015872%\">&#8203;\n</td><td align=\"left\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  \" align=\"left\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">17/2/24</span></p>\n</td></tr></table>\n</td></tr></table>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 48px 16px 48px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:middle;width:504px;\">\n<![endif]--><div class=\"xc504 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:middle;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" width=\"100%\"><tbody><tr><td style=\"border:none;vertical-align:middle;padding:8px 0px 8px 0px;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style width=\"100%\"><tbody><tr><td align=\"left\" class=\"x  fs-14 dt-FFFFFE\" style=\"font-size:0;word-break:break-word;\"><div style=\"text-align:left;\"><p style=\"Margin:0;text-align:left;mso-line-height-alt:24px;mso-ansi-font-size:16px;\"><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">Con este&nbsp;</span><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">nuevo aprendizaje</span><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">, &iexcl;deseamos qu&eacute; tus logros sean ilimitados y&nbsp;</span><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">tu &eacute;xito imparable</span><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">! ðŸš€</span></p><p style=\"Margin:0;mso-line-height-alt:24px;mso-ansi-font-size:16px;\"><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">&nbsp;</span></p><p style=\"Margin:0;mso-line-height-alt:24px;mso-ansi-font-size:16px;\"><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">Como siguientes pasos te recomendamos</span><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">&nbsp;iniciar sesi&oacute;n en tu plataforma AULA.</span></p><p style=\"Margin:0;mso-line-height-alt:24px;mso-ansi-font-size:16px;\"><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">&nbsp;</span></p><p style=\"Margin:0;mso-line-height-alt:24px;mso-ansi-font-size:16px;\"><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">Para ingresar estos son tus accesos. ðŸ”‘</span></p></div>\n</td></tr></tbody></table>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 48px 16px 48px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:top;width:504px;\">\n<![endif]--><div class=\"xc504 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:none;vertical-align:top;\" width=\"100%\"><tbody><tr><td align=\"left\" class=\"a\" style=\"background:transparent;font-size:0;padding:0;word-break:break-word;\">\n<table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" border=\"0\" style=\"color:#000000;font-family:Arial,sans-serif;font-size:13px;line-height:22px;table-layout:fixed;width:100%;border:none;\"><tr class=\"q \" ><td align=\"left\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  fs-14 \" align=\"left\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">Correo:</span></p>\n</td></tr></table>\n</td><td class=\"tgtr\" style=\"vertical-align:middle;color:transparent;font-size:0;\" width=\"1.5873015873015872%\">&#8203;\n</td><td align=\"right\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  fs-14 \" align=\"right\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">laura.figueroa@lottuseducation.com</span></p>\n</td></tr></table>\n</td></tr><tr class><td class=\"s\" style=\"font-size:0;padding:0;padding-bottom:0;word-break:break-word;color:transparent;\" aria-hidden=\"true\"><div style=\"height:8px;line-height:8px;\">&#8203;</div>\n</td></tr><tr class=\"q \" ><td align=\"left\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  fs-14 \" align=\"left\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:600;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">Contrase&ntilde;a:</span></p>\n</td></tr></table>\n</td><td class=\"tgtr\" style=\"vertical-align:middle;color:transparent;font-size:0;\" width=\"1.5873015873015872%\">&#8203;\n</td><td align=\"right\" class=\"u\" style=\"padding:0;height:19px;word-wrap:break-word;vertical-align:middle;\" width=\"49.20634920634921%\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\"><tr><td class=\"x  fs-14 \" align=\"right\" width=\"100%\"><p style=\"Margin:0;text-align:left;mso-ansi-font-size:14px;\"><span style=\"font-size:14px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#000000;line-height:136%;mso-line-height-alt:20px;mso-ansi-font-size:14px;\">password</span></p>\n</td></tr></table>\n</td></tr></table>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 48px 16px 48px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook dt-000000-outlook -outlook\" style=\"vertical-align:middle;width:504px;\">\n<![endif]--><div class=\"xc504 ogf c  dt-000000\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:middle;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" width=\"100%\"><tbody><tr><td style=\"border:none;vertical-align:middle;padding:8px 0px 8px 0px;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style width=\"100%\"><tbody><tr><td align=\"left\" class=\"x  al-l fs-14 dt-FFFFFE\" style=\"font-size:0;word-break:break-word;\"><div style=\"text-align:left;\"><p style=\"Margin:0;text-align:left;mso-line-height-alt:20px;mso-ansi-font-size:16px;\"><span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:400;color:#18181b;line-height:125%;mso-line-height-alt:20px;mso-ansi-font-size:16px;\">&iexcl;Te deseamos el mayor de los logros y un &eacute;xito sin l&iacute;mites! ðŸš€</span></p></div>\n</td></tr></tbody></table>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pt-0-outlook pr-16-outlook pb-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pt-0 pr-16 pb-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 0px 32px 0px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:middle;width:600px;\">\n<![endif]--><div class=\"xc600 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:middle;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:none;vertical-align:middle;\" width=\"100%\"><tbody><tr><td align=\"center\" vertical-align=\"middle\" class=\"b  fw-1\" style=\"font-size:0;padding:0;word-break:break-word;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:separate;width:116px;line-height:100%;\"><tbody><tr><td align=\"center\" bgcolor=\"#2b897e\" role=\"presentation\" style=\"border:none;border-radius:8px 8px 8px 8px;cursor:auto;mso-padding-alt:12px 0px 12px 0px;background:#2b897e;\" valign=\"middle\"> <a href=\"https://aula.ula.edu.mx/\" style=\"display:inline-block;width:116px;background:#2b897e;color:#ffffff;font-family:'Poppins','Arial',sans-serif;font-size:13px;font-weight:normal;line-height:100%;margin:0;text-decoration:none;text-transform:none;padding:12px 0px 12px 0px;mso-padding-alt:0;border-radius:8px 8px 8px 8px;\" target=\"_blank\"> <span style=\"font-size:16px;font-family:'Poppins','Arial',sans-serif;font-weight:700;color:#ffffff;line-height:150%;mso-line-height-alt:24px;mso-ansi-font-size:16px;\">Ir a AULA</span></a>\n</td></tr></tbody></table>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:#f4f4f5;background-color:#f4f4f5;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#f4f4f5;background-color:#f4f4f5;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 16px 16px 16px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:middle;width:568px;\">\n<![endif]--><div class=\"xc568 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:middle;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:none;vertical-align:middle;\" width=\"100%\"><tbody><tr><td align=\"center\" class=\"x  m\" style=\"font-size:0;padding-bottom:16px;word-break:break-word;\"><div style=\"text-align:center;\"><p style=\"Margin:0;text-align:center;mso-line-height-alt:14px;mso-ansi-font-size:12px;\"><span style=\"font-size:12px;font-family:'Arial',sans-serif;font-weight:400;color:#71717a;line-height:117%;mso-line-height-alt:14px;mso-ansi-font-size:12px;\">&iquest;Tienes preguntas o comentarios sobre tu programa de Extensi&oacute;n Universitaria? Estamos aqu&iacute; para ayudarte. Escr&iacute;benos a&nbsp;</span><span style=\"font-size:12px;font-family:'Arial',sans-serif;font-weight:400;color:#71717a;line-height:117%;text-decoration:underline;mso-line-height-alt:14px;mso-ansi-font-size:12px;\"><a href=\"mailto:imaru.arias@ula.edu.mx\" style=\"color:#71717a;text-decoration:underline;\" target=\"_blank\">imaru.arias@ula.edu.mx</a></span><span style=\"font-size:12px;font-family:'Arial',sans-serif;font-weight:400;color:#71717a;line-height:117%;mso-line-height-alt:14px;mso-ansi-font-size:12px;\">&nbsp;y responderemos tus dudas.&iexcl;Esperamos tu mensaje! ðŸš€</span></p></div>\n</td></tr><tr><td align=\"center\" class=\"o\" style=\"font-size:0;padding:0;padding-bottom:0;word-break:break-word;\">\n<!--[if mso | IE]>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\"><tr><td>\n<![endif]-->\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"><tbody><tr class=\"e  m\"><td style=\"padding:0 16px 0 0;vertical-align:middle;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:20px;\"><tbody><tr><td style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\"> <a href=\"https://www.facebook.com/ULA.Oficial\" target=\"_blank\"> <img alt=\"facebook\" title height=\"20\" src=\"https://e.hypermatic.com/9ced8159be280aea25015ecd4300394d.png\" style=\"display:block;\" width=\"20\"></a>\n</td></tr></tbody></table>\n</td></tr></tbody></table>\n<!--[if mso | IE]>\n</td><td>\n<![endif]-->\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"><tbody><tr class=\"e  m\"><td style=\"padding:0 16px 0 0;vertical-align:middle;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:20px;\"><tbody><tr><td style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\"> <a href=\"https://www.instagram.com/ula.oficial/\" target=\"_blank\"> <img alt=\"instagram\" title height=\"20\" src=\"https://e.hypermatic.com/81ea77648631bc4d45712390053da94f.png\" style=\"display:block;\" width=\"20\"></a>\n</td></tr></tbody></table>\n</td></tr></tbody></table>\n<!--[if mso | IE]>\n</td><td>\n<![endif]-->\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"><tbody><tr class=\"e  m\"><td style=\"padding:0 16px 0 0;vertical-align:middle;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:20px;\"><tbody><tr><td style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\"> <a href=\"https://www.tiktok.com/@ula_oficial\" target=\"_blank\"> <img alt=\"tiktok\" title height=\"20\" src=\"https://e.hypermatic.com/01df96539f3fcab8bb749174a5b6b9e4.png\" style=\"display:block;\" width=\"20\"></a>\n</td></tr></tbody></table>\n</td></tr></tbody></table>\n<!--[if mso | IE]>\n</td><td>\n<![endif]-->\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"><tbody><tr class=\"e  m\"><td style=\"padding:0 16px 0 0;vertical-align:middle;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:20px;\"><tbody><tr><td style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\"> <a href=\"https://www.linkedin.com/school/universidad-latinoamericana/\" target=\"_blank\"> <img alt=\"linkedin\" title height=\"20\" src=\"https://e.hypermatic.com/3e99136030108d1dd884a8e0d13be369.png\" style=\"display:block;\" width=\"20\"></a>\n</td></tr></tbody></table>\n</td></tr></tbody></table>\n<!--[if mso | IE]>\n</td><td>\n<![endif]-->\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"float:none;display:inline-table;\"><tbody><tr class=\"e  \"><td style=\"padding:0;padding-right:0;vertical-align:middle;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:20px;\"><tbody><tr><td style=\"font-size:0;height:20px;vertical-align:middle;width:20px;\"> <a href=\"https://www.youtube.com/@UniversidadLatinoamericana\" target=\"_blank\"> <img alt=\"youtube\" title height=\"20\" src=\"https://e.hypermatic.com/943bae1c776f4e5838719d8827b1cf49.png\" style=\"display:block;\" width=\"20\"></a>\n</td></tr></tbody></table>\n</td></tr></tbody></table>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"r-outlook -outlook pr-16-outlook pl-16-outlook -outlook\" role=\"presentation\" style=\"width:600px;\" width=\"600\"><tr><td style=\"line-height:0;font-size:0;mso-line-height-rule:exactly;\">\n<![endif]--><div class=\"r  pr-16 pl-16\" style=\"background:transparent;margin:0px auto;max-width:600px;\">\n<table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:transparent;width:100%;\"><tbody><tr><td style=\"border:none;direction:ltr;font-size:0;padding:16px 16px 16px 16px;text-align:left;\">\n<!--[if mso | IE]>\n<table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"c-outlook -outlook -outlook\" style=\"vertical-align:middle;width:568px;\">\n<![endif]--><div class=\"xc568 ogf c\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:middle;width:100%;\">\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:none;vertical-align:middle;\" width=\"100%\"><tbody><tr><td align=\"center\" class=\"x\" style=\"font-size:0;word-break:break-word;\"><div style=\"text-align:center;\"><p style=\"Margin:0;text-align:center;mso-line-height-alt:14px;mso-ansi-font-size:12px;\"><span style=\"font-size:12px;font-family:'Arial',sans-serif;font-weight:400;color:#a1a1aa;line-height:117%;mso-line-height-alt:14px;mso-ansi-font-size:12px;\">Universidad Latinoamericana</span></p><p style=\"Margin:0;mso-line-height-alt:14px;mso-ansi-font-size:12px;\"><span style=\"font-size:12px;font-family:'Arial',sans-serif;font-weight:400;color:#a1a1aa;line-height:117%;mso-line-height-alt:14px;mso-ansi-font-size:12px;\">Av. Gabriel Mancera #1402, Col. Del Valle Sur, Alcald&iacute;a Benito Ju&aacute;rez, C.P. 03100, Ciudad de M&eacute;xico</span></p></div>\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]-->\n</td></tr></tbody></table></div>\n<!--[if mso | IE]>\n</td></tr></table>\n<![endif]--></div>\n</body>\n</html>`
    
    const priority = body.priority || 'Normal'
    this.utils.authSF().pipe(
      mergeMap(authRes => {
        const token = authRes.data.access_token
        const xml = this.email.generateXML(token, templatein, subject, toAddress, priority )
        // console.log(xml);
        
       return  this.utils.sendSFemail(xml)
      }),
      catchError((err, caught)=> { console.log(err); console.log(); response.status(err.response.status).send(err.response.data); return caught })
    ).subscribe(res => {
        // console.log(res);
        if ([200, 201].includes(res.status) ) {
          console.log(res);
          
          response.send(JSON.stringify(res.data))
        }
      })
  }

  @Post('/compile')
  compileEmail(@Body() body: { template_id: number, params: { [key:string]: any } }, @Res() response: any) {
    body.template_id
    if (!body.template_id) {
      response.status(400).send("please send a template id")
    }
    
    this.utils.fetchEmailTemplate(body.template_id).pipe(catchError((err, caught) => {console.log(err); return caught})).subscribe((res) => {
      console.log(res);
      const template_data = res.data.data.attributes
      const template = Handlebars.compile(template_data.html);
      let params = (body.params || template_data.params) || {}
      // const message = (!body.params && template_data.params) && "No params where sent, will use default params from template." 

      const compiled = template(params)
      console.log(compiled);
      
      response.send(JSON.stringify({template: compiled, params}))
    } )
    // body.data
  }

  @Post('/create/template')
  sendTemplateStrapi(@Body() body: { name: string, subject: string, preheader: string, html: string  }, @Res() response: any) {
    const params = body.html.split('/{/{')
    params.splice(0,1)
    const finalParams = params.reduce((acc, param) => {
      acc[param.split('/}/}')[0].trim()] = "data prueba, cambiar en strapi"
      return acc
    }, {})
    console.log(finalParams);
    response.send('ok')
    
  }
}
